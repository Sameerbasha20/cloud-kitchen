<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Orders | CloudKitchen</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>

<body>

<!-- ===============================
     NAVBAR LOADER
================================ -->
<script type="module">
  import { initNavbar } from "./navbar.js";

  fetch("navbar.html")
    .then(res => res.text())
    .then(html => {
      document.body.insertAdjacentHTML("afterbegin", html);
      initNavbar("orders"); // highlight My Orders
    });
</script>

<!-- ===============================
     ORDERS SECTION
================================ -->
<section class="orders">
  <div class="container">

    <div class="section-header">
      <h2>My Orders</h2>
      <p>Your recent orders and their status</p>
    </div>

    <div id="orders-list"></div>

  </div>
</section>

<!-- ===============================
     FOOTER
================================ -->
<footer class="footer">
  <p>© 2026 CloudKitchen</p>
</footer>

<!-- ===============================
     ORDERS LOGIC
================================ -->
<script type="module">
  import { auth, db } from "./firebase.js";
  import {
    collection,
    query,
    where,
    orderBy,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import {
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const ordersList = document.getElementById("orders-list");

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      ordersList.innerHTML = "<p>Please login to view your orders.</p>";
      return;
    }

    try {
      const q = query(
        collection(db, "orders"),
        where("userId", "==", user.uid),
        orderBy("createdAt", "desc")
      );

      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        ordersList.innerHTML = "<p>No orders yet.</p>";
        return;
      }

      ordersList.innerHTML = "";

      snapshot.forEach(docSnap => {
        const order = docSnap.data();
        const date = order.createdAt?.toDate().toLocaleString() || "";

        let itemsHtml = "";
        (order.items || []).forEach(item => {
          const qty = item.qty || item.quantity || 1;
          const lineTotal = (item.price || 0) * qty;
          itemsHtml += `
            <li>
              ${item.name} × ${qty} — ₹${lineTotal}
            </li>
          `;
        });

        const div = document.createElement("div");
        div.className = "order-card";

        div.innerHTML = `
          <h4>Order ID: ${docSnap.id}</h4>
          <p><strong>Date:</strong> ${date}</p>
          <p><strong>Status:</strong> ${order.status}</p>
          <ul>${itemsHtml}</ul>
          <h4>Total: ₹${order.total}</h4>
        `;

        ordersList.appendChild(div);
      });
    } catch (err) {
      console.error(err);
      ordersList.innerHTML = "<p>Failed to load orders. Please try again later.</p>";
    }
  });
</script>

<!-- EXISTING JS -->
<script type="module" src="auth.js"></script>
<script src="scroll.js"></script>

</body>
</html>
