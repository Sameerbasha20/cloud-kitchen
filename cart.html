<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cart | CloudKitchen</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>

<body>

<!-- ===============================
     NAVBAR LOADER
================================ -->
<script type="module">
  import { initNavbar } from "./navbar.js";

  fetch("navbar.html")
    .then(res => res.text())
    .then(html => {
      document.body.insertAdjacentHTML("afterbegin", html);
      initNavbar("cart");
    });
</script>

<!-- ===============================
     CART
================================ -->
<section class="cart">
  <div class="container">

    <div class="section-header">
      <h2>Your Cart</h2>
      <p>Review items before placing order</p>
    </div>

    <div id="cart-items"></div>

    <div class="cart-summary">
      <h3 id="cart-total">Total: ₹0</h3>
      <button id="place-order" class="btn-primary">Place Order</button>
    </div>

  </div>
</section>

<!-- ===============================
     FOOTER
================================ -->
<footer class="footer">
  <p>© 2026 CloudKitchen</p>
</footer>

<!-- ===============================
     CART LOGIC
================================ -->
<script type="module">
  import { getCart, updateCartCount, placeOrder } from "./cart.js";

  const cartItemsEl = document.getElementById("cart-items");
  const totalEl = document.getElementById("cart-total");
  const placeOrderBtn = document.getElementById("place-order");

  // Get cart from storage
  let cart = getCart() || [];

  // Normalize shape coming from menu.js (quantity + image)
  const normalizeCart = (items) =>
    (items || []).map(item => ({
      ...item,
      // prefer existing qty if present, else quantity from menu.js, else 1
      qty: item.qty && item.qty > 0
        ? item.qty
        : (item.quantity && item.quantity > 0 ? item.quantity : 1),
      // prefer imageUrl if present, else image from menu.js, else empty string
      imageUrl: item.imageUrl || item.image || ""
    }));

  cart = normalizeCart(cart);

  function persistCart() {
    // Save a clean, consistent shape
    const normalized = cart.map(item => ({
      id: item.id,
      name: item.name,
      price: item.price,
      qty: item.qty,
      imageUrl: item.imageUrl
    }));
    localStorage.setItem("cart", JSON.stringify(normalized));
    updateCartCount();
  }

  function renderCart() {
    cartItemsEl.innerHTML = "";
    let total = 0;

    if (cart.length === 0) {
      cartItemsEl.innerHTML = "<p>Your cart is empty.</p>";
      totalEl.textContent = "Total: ₹0";
      placeOrderBtn.disabled = true;
      return;
    }

    placeOrderBtn.disabled = false;

    cart.forEach((item, index) => {
      const qty = item.qty && item.qty > 0 ? item.qty : 1;
      const price = Number(item.price) || 0;
      const imageSrc = item.imageUrl || "images/placeholder.jpg";

      total += price * qty;

      const div = document.createElement("div");
      div.className = "cart-item";

      div.innerHTML = `
        <img src="${imageSrc}" alt="${item.name}">
        <div class="cart-info">
          <h4>${item.name}</h4>
          <p>₹${price} × ${qty}</p>
          <div class="cart-actions">
            <button class="qty-btn inc">+</button>
            <button class="qty-btn dec">−</button>
            <button class="remove-btn">Remove</button>
          </div>
        </div>
      `;

      // Increase quantity
      div.querySelector(".inc").onclick = () => {
        item.qty = (item.qty || 1) + 1;
        persistCart();
        renderCart();
      };

      // Decrease quantity
      div.querySelector(".dec").onclick = () => {
        item.qty = (item.qty || 1) - 1;
        if (item.qty <= 0) {
          cart.splice(index, 1);
        }
        persistCart();
        renderCart();
      };

      // Remove item
      div.querySelector(".remove-btn").onclick = () => {
        cart.splice(index, 1);
        persistCart();
        renderCart();
      };

      cartItemsEl.appendChild(div);
    });

    totalEl.textContent = `Total: ₹${total}`;
  }

  placeOrderBtn.onclick = async () => {
    const ok = await placeOrder();
    if (!ok) return; // if order failed, keep current cart

    cart = getCart() || [];
    cart = normalizeCart(cart);
    renderCart();
  };

  updateCartCount();
  renderCart();
</script>

<!-- EXISTING JS -->
<script type="module" src="auth.js"></script>
<script src="scroll.js"></script>

</body>
</html>
